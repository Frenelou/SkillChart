<!DOCTYPE html>
<meta charset="utf-8" />
<style>
  .links line {
    stroke: #999;
    stroke-opacity: 0.6;
  }

  .nodes circle {
    stroke: #fff;
    stroke-width: 1.5px;
  }

  text {
    font-family: sans-serif;
    font-size: 10px;
  }

  #devDetails {
    display: none;
  }

  #devDetails.show {
    display: block;
  }

  #technoDetails {
    display: none;
  }

  #technoDetails.show {
    display: block;
  }

  #devName,
  #technoName {
    font-weight: 700;
  }
</style>
<svg width="960" height="600">
  <!-- <g></g> -->
</svg>

<div id="devDetails">
  <div>
    DÃ©veloppeur:
    <span id="devName"></span>
  </div>
  <ul id="devTechnos"></ul>
</div>

<div id="technoDetails">
  <div>
    Technologies:
    <span id="technoName"></span>
  </div>
  <ul id="technoDevs"></ul>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
  var svg = d3.select('svg'),
    width = +svg.attr('width'),
    height = +svg.attr('height');

  //   var color = d3.scaleOrdinal(d3.schemeCategory20);

  function color(group) {
    console.log(group);
    switch (group) {
      case 1: // Dev
        return '#b22320';
        break;
      case 2: // JS
        return '#034a2f';
        break;
      case 3: // PHP
        return '#ffd135';
        break;
      case 4: // Testing
        return '#a99440';
        break;
      case 5: // CI CD
        return '#febe02';
        break;
      case 6: // Magento
        return '#feaa00';
        break;
      case 7: // AWS
        return '#fe9901';
        break;
      case 8: // HTML/CSS
        return '#05603c';
        break;
      case 9:
        return '#05754a';
        break;
      case 10:
        return '#568551';
        break;
      case 11:
        return '#fee66c';
        break;
      default:
        return 'black';
        break;
    }
  }

  var simulation = d3
    .forceSimulation()
    .force(
      'link',
      d3.forceLink().id(function (d) {
        return d.id;
      })
    )
    .force('charge', d3.forceManyBody())
    .force('center', d3.forceCenter(width / 2, height / 2));

  d3.json('dev.json', function (error, graph) {
    if (error) throw error;

    var link = svg
      .append('g')
      .attr('class', 'links')
      .selectAll('line')
      .data(graph.links)
      .enter()
      .append('line')
      .attr('stroke-width', function (d) {
        return Math.sqrt(d.value);
      });

    var node = svg.append('g').attr('class', 'nodes').selectAll('g').data(graph.nodes).enter().append('g');

    var circles = node
      .append('circle')
      .attr('r', function (d) {
        if (d.group === 1 || d.parent) {
          return 15;
        } else {
          return 10;
        }
      })
      .attr('fill', function (d) {
        return color(d.group);
      });

    // Create a drag handler and append it to the node object instead
    var drag_handler = d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended);

    drag_handler(node);
    node.on('click', function (d) {
      openDetails(d);
    });

    function openDetails(element) {
      console.log(element);
      console;
      if (element.group === 1) {
        // Dev
        document.getElementById('technoDetails').classList.remove('show');
        document.getElementById('devDetails').classList.add('show');
        document.getElementById('devName').innerHTML = element.nom;
      } else {
        // Technology
        document.getElementById('technoDetails').classList.add('show');
        document.getElementById('devDetails').classList.remove('show');
      }
    }

    var lables = node
      .append('text')
      .text(function (d) {
        return d.id;
      })
      .attr('x', 6)
      .attr('y', 3);

    node.append('title').text(function (d) {
      return d.id;
    });

    simulation.nodes(graph.nodes).on('tick', ticked);

    simulation.force('link').links(graph.links);

    // let zoom = d3.zoom().on('zoom', handleZoom);

    // function handleZoom(e) {
    //   d3.select('svg').attr('transform', e.transform);
    // }

    // function initZoom() {
    //   d3.select('svg').call(zoom);
    // }
    // initZoom();
    function ticked() {
      link
        .attr('x1', function (d) {
          return d.source.x;
        })
        .attr('y1', function (d) {
          return d.source.y;
        })
        .attr('x2', function (d) {
          return d.target.x;
        })
        .attr('y2', function (d) {
          return d.target.y;
        });

      node.attr('transform', function (d) {
        return 'translate(' + d.x + ',' + d.y + ')';
      });
    }
  });

  function dragstarted(d) {
    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }

  function dragended(d) {
    if (!d3.event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }
</script>
